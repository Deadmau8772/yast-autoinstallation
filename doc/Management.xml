  <chapter>
  <title>Configuration Management and Auto-Installation Process</title>


  <section>
    <title>Installation Server Setup</title>
    
    <para>
      User intervention depends much on how the server side of a network installation is
      prepared. In a full network installation, you  have only to turn the
      client on to initiate an auto-installation process. This can also be
      automated using different technologies available today (Remote Power
      Management) or by using	<ulink
	url="http://www.scyld.com/expert/wake-on-lan.html">Wake-on-LAN</ulink> (WOL).
    </para>
    <section>
      <title>Setting up an installation repository</title>
      <para>
	A system can be setup to serve as a configuration repository. The clients will access
	the server resources in order to boot, install packages and so on. To
	achieve this, various network services must be properly set up.
      </para>
      <para>
	The installation server should export the  &company-suse;  Linux distribution's files
	via &nfs;. Create a directory on a filesystem with enough free space
	(several gigabytes) and copy the contents of the CD-ROMs into this
	directory. This directory is then to be exported via
	&nfs; (via an appropriate entry in
	<filename>/etc/exports</filename>). The following steps describe how to
	create an installation repository:
	
      </para>
      <para>
	Login on the machine designated as installation server and create a
	directory to hold the  &company-suse;  Linux distribution files,
	i.e. <filename> /usr/local/SuSE/current</filename>. 
      </para>
      <para>
	In our example <filename>/usr/local/SuSE/current</filename> is the base directory for the  &company-suse;  Linux
	distribution. The location of this directory can be specified  in the <emphasis>info</emphasis> file or on
	the command line of the kernel (see  below) using the
	<emphasis>install</emphasis>
	keyword. (i.e. <emphasis>install=nfs://192.168.1.1/usr/local/SuSE/current</emphasis>)
      </para>
      <para>
	Now copy the files from  all CDs into the
	<emphasis>current</emphasis> directory or just copy those CDs
	required for the installation. Make sure that all packages needed for
	the installation are copied. Make sure the dot files in the root
	directory of  the CD-ROM are
	also copied, these files serve as identification of the installation
	media. Use the following command to copy the CDs.

      </para>
      <screen>
mount /cdrom
cd /cdrom && cp -va . /usr/local/SuSE/current ; cd -
umount /cdrom
      </screen>
      <para>
	Repeat this sequence for all other CDs. The directory
	can have 2 different structures which can be used for installation:
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    The contents of all CDs is copied into one directory and thus
	    creating single directory structure with a
	    subdirectory <emphasis>suse</emphasis> which included all the
	    packages. This type of structure is recommended as it
	    is easier to manage and will provide a true, single source
	    installation medium.
	  </para>
	  <para>
	    To make the directory look like a single medium for the client,
	    it is possible to re-create  the package database available on the
	    first CD using the script <command>create_package_descr</command>
	    which is available in <filename>/usr/lib/YaST2/bin/</filename>.	   
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Copy the CDs into subdirectories named after the CD number,
	    i.e. CD1, CD2, etc.
	  </para>
	  <para>
	    Using this structure you will still be able to perform &nfs;
	    installations, but the single directories will be treated as if
	    they were different mediums. 
	  </para>
	</listitem>
      </itemizedlist>
      <para>
	After you have copied the CDs into the installation directory, make
	sure it is exported via &nfs;. You can do that using &yast2; by using the
	&nfs; server module.
      </para>
      <para>
	Additionally, you need to make the following services  start every
	time the system boots.
      </para>
      <itemizedlist>
	<listitem>
	  <para>
	    nfsserver
	  </para>
	</listitem>
	<listitem>
	  <para>
	    portmap
	  </para>
	</listitem>
      </itemizedlist>
    </section>

    <section>
      <title>Setting up  a configuration repository</title>
      <para>
	A configuration repository holds the control files for multiple
	machines. The control files can have any file names, which have to
	specified at the boot time of a client. To avoid supplying the
	profile name for every client, you can only define the directory of
	the control files. If a directory is specified, then the client tries
	to load a file with a name matching it's IP address in hex
	mode.  This has the advantage that you will be dealing with
	consistent file names rather than IPs as file names which might lead to
	some confusion.
      </para>
      <para>
	The configuration repository is the same directory you have to define
	if you are using the configuration system for creating control files.
      </para>
      <section>
	<title>&http; Repository</title>
	<para>
	  To be able to use the &http; protocol to retrieve control file while
	  auto-installing, you need a working &http; server on the server
	  side. Install <emphasis>Apache</emphasis> or your favorite web
	  server and enable it using &yast2;. Normally the the web server root
	  directory resides in <filename>/srv/www/htdocs</filename>
	  so you need to create a subdirectory below the root directory of
	  the web server which will be your configuration repository.
	</para>
	
      </section>
      <section>
	<title>&nfs; Repository</title>
	<para>
	  Create a directory and make it available via &nfs; to the clients by
	  exporting it. This directory may for example be in the same place
	  where you have copied the CDs. (i.e. <filename>/usr/local/SuSE</filename>)
	</para>
      </section>
      <section>
	
	<title>&tftp; Repository</title>
	<para>
	  By default the &tftp; directory is available under
	  <filename>/tftpboot</filename> which can also contain boot images
	  if you are booting over network. Do not forget to enable TFTP in
	  the Inetd configuration file
	  (<filename>/etc/inetd.conf</filename>). <emphasis>Inetd</emphasis> configuration can be
	  done using &yast2;.
	</para>
      </section>
    </section>
  </section>

  
  <section>
    <title>Choosing the right Boot Medium</title>
    <para>
      There are different methods for booting the client. The computer can boot from
      its network interface card (NIC) to receive the boot images via  &dhcp; /TFTP
      or a suitable kernel as well as an initrd image are loaded from a
      floppy or a boot-able CD-ROM. 
    </para>
    <section>
      <title>
	Booting from a floppy
      </title>
      <para>
	For testing/rescue purposes or because the NIC does not have a PROM or PXE
	you can build a boot floppy to use with &autoyast2;. Using a floppy
	to initiate an auto-install process is limited due to the size of the
	data a floppy can hold. However, it is still  possible to use
	floppies when auto-installing a single, disconnected machine.
      </para>
      <para>
	Floppies can be used to store the control file, especially when using
	the original  &company-suse;  CD-ROMs for a single, disconnected machine. Using the
	kernel command line, you can specify the location of the control
	file on the floppy.
      </para>
      <para>
	Even without specifying any command line options, it is still possible to initiate the
	auto-install process by placing a control file on a floppy with a
	special, pre-defined file name. (<filename>autoinst.xml</filename>) &yast2; will check for
	<filename>autoinst.xml</filename> upon startup and if it was found it
	will switch from interactive to automated installation.
      </para>
    </section>

    <section>
      <title>Booting from CD-ROM</title>
      <para>
	You can use the original  &company-suse;  CD-ROMs in combination with other
	media, i.e. with a floppy to hold the control file or in combination
	with network where the control file can be located.
      </para>
      <para>
	It is also possible to create customized CD-ROMs to hold only the
	package you need in addition to the control file which also can be
	saved on the CD-ROM. This method requires creation of CD-ROMs
	every time you wish to change the configuration though.
      </para>
    </section>
  </section>

  <section id="Installation.process">
    
    <title>
      The Auto-Installation Process
    </title>
    <para>
      After the system has booted and the control file has been retrieved,
      &yast2; performs configuration of the system according to the information
      contained in the  control
      file. All the configuration is summarized in a window that is shown by
      default and should be deactivated if a full automatic installation is
      needed.      
    </para>
    <para>
      When reaching the point where the summary of the configuration is shown,
      &yast2; has only probed hardware and prepared the system for
      auto-installation, thus, nothing has been changed in the system yet, so
      that in case of any error, the process still can be aborted.
    </para>
    
    
    <para>
      A system should be automatically install-able without the need to have
      any graphic adaptor or monitor. Having a monitor attached to the
      client machine is nevertheless recommended to follow the process and
      to get feedback in case of any errors. Choosing between the Qt and the
      Ncurses interfaces is possible. For headless
      clients, system messages can be monitored using the serial console.
    </para>
    <section id="Installation.Interface.X11">
      <title>
	X11 Interface
      </title>
      <para>
	This is the  default interface while auto-installing. No special
	variables are required to activate it.
      </para>
    </section>
    <section id="Installation.Interface.SerialConsole">
      <title>
	Serial console
      </title>
      <para>
	You can start installing a system using the serial console by adding
	the keyword console (i.e. console=ttyS0) to the command line of the
	kernel. This will start linuxrc in console mode and later in the
	process, &yast2; also is started in serial console mode.
      </para>
    </section>
    <section id="Installation.Interface.Ncurses">
      <title>
	Text based YaST2-Installation
      </title>
      <para>
	This option can also be activated on the command line. This will start
	YaST2 in <emphasis>Ncurses</emphasis> mode. To start &yast2; in text
	mode, add <emphasis>textmode=1</emphasis> on the command line.
      </para>
      <para>
	Starting &yast2; in text mode is recommended when installing  a client
	with less than 64 MB or when X11 is not being configured at all,
	especially on headless machines.
      </para>
    </section>
  </section>


  <section>    
    <title>
      System Configuration 
    </title>
    <para>
      The system configuration during auto-installation can be seen as the
      most important part of the whole process. Customizing a system to your
      environment needs is what makes an auto-installation system attractive,
      not the installation part.
    </para>
    <para>
      As you have seen in the previous chapters, almost anything can be
      configured automatically on the target system. In addition to the
      pre-defined directives, you can always  use post-scripts to change other
      things in the system. Additionally you can change any system variables and
      if required, copy complete configuration files into the target system.
    </para>
    <section>
      <title>
	Post-Install and System Configuration
      </title>
      <para>
	The Post-Installation and the System Configuration are initiated directly after the last
	package is installed in the target system  and is continued after the
	system has booted for the first time.
      </para>
      <para>
	Before the system is booted for the first time, &yast2; writes all data
	collected during installation into the system and finally it writes the
	boot loader in the specified location. In addition to these regular
	tasks, which are also done when performing a regular installation, YaST2
	executes the <emphasis>chroot-scripts</emphasis> as specified in the
	control file. Note that these scripts are executed while the system is
	still not mounted.
      </para>      
      <para>
	If a different kernel than the default is installed, a hard reboot will
	be required. A hard reboot can also be forced during auto-installation,
	independent of the installed kernel. This can be accomplished using the
	<emphasis>reboot</emphasis> property of the
	<emphasis>general</emphasis> resource. (See <link
	  linkend="CreateProfile.General">General Options</link>)
      </para>
    </section>
    <section>
      <title>System Customization</title>
      <para>
	Most of the system customization is done in the second stage of the
	installation. &yast2; provides most of the important resources needed to
	bring up  a system to a usable , general state. However, you may have
	other requirements for the installed system. If the required
	customizations can't be done using &yast2; resources, then the
	post-install scripts can be used to accomplish this task.
      </para>
      <para>
	You can define an unlimited number of custom scripts in the control
	file either by editing the control file or by using the configuration
	system.	
      </para>      
    </section>
  </section>

</chapter>


      <!--
       Local Variables:
       mode: xml
       sgml-parent-document: ("autoyast2.xml" "book" "chapter")
       End:
      -->
